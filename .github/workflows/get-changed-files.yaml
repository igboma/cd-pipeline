name: Create Deployment for PR
on:
  merge_group:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  get_changed_files:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' &&
      (github.event.action != 'closed' || (github.event.action == 'closed' && github.event.pull_request.merged == true)) }}
    outputs:
      COMPONENT: ${{ steps.determine-changed-files.outputs.COMPONENT }}
      ENVIRONMENT: ${{ steps.determine-changed-files.outputs.ENVIRONMENT }}
      VERSION: ${{ steps.determine-changed-files.outputs.VERSION }}
      IS_RELEASE: ${{ steps.determine-changed-files.outputs.IS_RELEASE }}
      HEO_REVISION: ${{ steps.determine-changed-files.outputs.HEO_REVISION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get all conf.yaml file changes
        id: changed-files-yaml
        uses: tj-actions/changed-files@v41

      - name: Download and run go-tools
        id: determine-changed-files
        run: |
          wget https://github.com/igboma/go-tools/releases/download/v1.0.0/go-tools
          chmod +x go-tools
          ./go-tools ${{ github.workspace }}
        env:
          CHANGED_FILES: ${{ steps.changed-files-yaml.outputs.all_changed_files }}
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
          GITHUB_EVENT_PR_MERGED: ${{ github.event.pull_request.merged }}
          GITHUB_OUTPUT: $GITHUB_OUTPUT

      - name: Echo the outputs
        run: |
          echo "COMPONENT: ${{ steps.determine-changed-files.outputs.COMPONENT }}"
          echo "ENVIRONMENT: ${{ steps.determine-changed-files.outputs.ENVIRONMENT }}"
          echo "VERSION: ${{ steps.determine-changed-files.outputs.VERSION }}"
          echo "IS_RELEASE: ${{ steps.determine-changed-files.outputs.IS_RELEASE }}"
          echo "HEO_REVISION: ${{ steps.determine-changed-files.outputs.HEO_REVISION }}"
